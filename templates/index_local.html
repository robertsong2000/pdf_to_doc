<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF to DOCX Converter</title>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .converter-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            margin-top: 50px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            background: #f8f9ff;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            color: #667eea;
            margin-bottom: 20px;
        }

        .file-input {
            display: none;
        }

        .btn-convert {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 40px;
            font-size: 18px;
            border-radius: 50px;
            transition: all 0.3s ease;
        }

        .btn-convert:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            color: white;
        }

        .btn-convert:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-outline-primary {
            color: #667eea;
            border-color: #667eea;
        }

        .btn-outline-primary:hover {
            background-color: #667eea;
            border-color: #667eea;
            color: white;
        }

        .progress-container {
            margin-top: 20px;
            display: none;
        }

        .progress-header {
            margin-bottom: 10px;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }

        .progress-percentage {
            font-size: 1.2em;
            color: #667eea;
            font-weight: bold;
        }

        .progress-label {
            font-size: 0.9em;
            color: #666;
        }

        .progress {
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            background-color: #e9ecef;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);
        }

        .progress-bar {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            height: 100%;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        .status-message {
            margin-top: 15px;
            padding: 15px;
            border-radius: 8px;
            font-weight: 500;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .file-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border-left: 4px solid #667eea;
        }

        .download-btn {
            background: #28a745;
            border: none;
            color: white;
            padding: 10px 30px;
            border-radius: 50px;
            transition: all 0.3s ease;
        }

        .download-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            color: white;
        }

        .btn-outline-danger {
            color: #dc3545;
            border-color: #dc3545;
        }

        .btn-outline-danger:hover {
            background-color: #dc3545;
            border-color: #dc3545;
            color: white;
        }

        .btn-lg {
            padding: 0.5rem 1rem;
            font-size: 1.25rem;
            border-radius: 0.3rem;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.2rem;
        }

        .title-icon {
            font-size: 48px;
            color: #667eea;
            margin-right: 15px;
        }

        .features {
            display: flex;
            justify-content: space-around;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid #eee;
        }

        .feature {
            text-align: center;
            flex: 1;
        }

        .feature i {
            font-size: 32px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none !important;
        }

        /* Basic button styles */
        button {
            background: none;
            border: none;
            cursor: pointer;
        }

        /* Text utility classes */
        .text-muted {
            color: #6c757d !important;
        }

        .text-center {
            text-align: center !important;
        }

        .text-success {
            color: #28a745 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .mb-2 {
            margin-bottom: 0.5rem !important;
        }

        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .mb-4 {
            margin-bottom: 1.5rem !important;
        }

        .mt-2 {
            margin-top: 0.5rem !important;
        }

        .mt-3 {
            margin-top: 1rem !important;
        }

        .mt-4 {
            margin-top: 1.5rem !important;
        }

        .ms-2 {
            margin-left: 0.5rem !important;
        }

        /* Flex utilities */
        .d-inline-flex {
            display: inline-flex !important;
        }

        .d-flex {
            display: flex !important;
        }

        .justify-content-between {
            justify-content: space-between !important;
        }

        .align-items-center {
            align-items: center !important;
        }

        .fw-bold {
            font-weight: bold !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="converter-container">
            <div class="text-center mb-4">
                <h1 class="d-inline-flex align-items-center">
                    <span class="title-icon">ğŸ“„</span>
                    PDF to DOCX Converter
                </h1>
                <p class="text-muted mt-2">å¿«é€Ÿã€ç®€å•ã€å®‰å…¨çš„PDFè½¬DOCXåœ¨çº¿è½¬æ¢å·¥å…·</p>
            </div>

            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">â˜ï¸</div>
                <h3>æ‹–æ‹½PDFæ–‡ä»¶åˆ°è¿™é‡Œ</h3>
                <p class="text-muted">æˆ–è€…ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
                <button type="button" class="btn-outline-primary btn-lg">
                    ğŸ“ é€‰æ‹©æ–‡ä»¶
                </button>
                <input type="file" id="fileInput" class="file-input" accept=".pdf">
                <p class="text-muted mt-3 mb-0">æ”¯æŒæœ€å¤§ 16MB çš„PDFæ–‡ä»¶</p>
            </div>

            <div class="file-info hidden" id="fileInfo">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-danger">ğŸ“„</span>
                        <span id="fileName" class="fw-bold"></span>
                        <span id="fileSize" class="text-muted ms-2"></span>
                    </div>
                    <button type="button" class="btn-outline-danger btn-sm" id="removeFile">
                        âœ• ç§»é™¤
                    </button>
                </div>
            </div>

            <div class="text-center mt-4">
                <button type="button" class="btn-convert" id="convertBtn" disabled>
                    âœ¨ å¼€å§‹è½¬æ¢
                </button>
            </div>

            <div class="progress-container" id="progressContainer">
                <div class="progress-header">
                    <div class="progress-text">
                        <span class="progress-percentage" id="progressPercentage">0%</span>
                        <span class="progress-label">è½¬æ¢è¿›åº¦</span>
                    </div>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%"></div>
                </div>
                <div class="status-message info" id="statusMessage">
                    â„¹ï¸ <span id="statusText">å‡†å¤‡è½¬æ¢...</span>
                </div>
            </div>

            <div class="text-center hidden" id="downloadContainer">
                <h4 class="text-success mb-3">
                    âœ… è½¬æ¢å®Œæˆï¼
                </h4>
                <button type="button" class="download-btn" id="downloadBtn">
                    â¬‡ï¸ ä¸‹è½½DOCXæ–‡ä»¶
                </button>
            </div>

            <div class="features">
                <div class="feature">
                    <div>âš¡</div>
                    <h6>å¿«é€Ÿè½¬æ¢</h6>
                    <p class="text-muted mb-0">ç§’çº§å¤„ç†é€Ÿåº¦</p>
                </div>
                <div class="feature">
                    <div>ğŸ”’</div>
                    <h6>å®‰å…¨å¯é </h6>
                    <p class="text-muted mb-0">æ–‡ä»¶è‡ªåŠ¨æ¸…ç†</p>
                </div>
                <div class="feature">
                    <div>ğŸ“</div>
                    <h6>ä¿æŒæ ¼å¼</h6>
                    <p class="text-muted mb-0">ä¿ç•™åŸå§‹å¸ƒå±€</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let currentTaskId = null;

        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const convertBtn = document.getElementById('convertBtn');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeFileBtn = document.getElementById('removeFile');
        const progressContainer = document.getElementById('progressContainer');
        const progressBar = document.getElementById('progressBar');
        const statusMessage = document.getElementById('statusMessage');
        const statusText = document.getElementById('statusText');
        const downloadContainer = document.getElementById('downloadContainer');
        const downloadBtn = document.getElementById('downloadBtn');

        // Upload area click
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // File input change
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFileSelect(file);
            }
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');

            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') {
                handleFileSelect(file);
            } else {
                alert('è¯·é€‰æ‹©PDFæ–‡ä»¶');
            }
        });

        // Remove file
        removeFileBtn.addEventListener('click', () => {
            resetUpload();
        });

        // Convert button
        convertBtn.addEventListener('click', () => {
            if (selectedFile) {
                convertFile();
            }
        });

        // Download button
        downloadBtn.addEventListener('click', () => {
            if (currentTaskId) {
                window.location.href = `/api/download/${currentTaskId}`;
                setTimeout(() => {
                    cleanupFiles();
                }, 1000);
            }
        });

        function handleFileSelect(file) {
            if (file.type !== 'application/pdf') {
                alert('è¯·é€‰æ‹©PDFæ–‡ä»¶');
                return;
            }

            if (file.size > 16 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡16MB');
                return;
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileSize.textContent = `(${formatFileSize(file.size)})`;

            uploadArea.classList.add('hidden');
            fileInfo.classList.remove('hidden');
            convertBtn.disabled = false;

            resetProgress();
        }

        function resetUpload() {
            selectedFile = null;
            fileInput.value = '';
            uploadArea.classList.remove('hidden');
            fileInfo.classList.add('hidden');
            convertBtn.disabled = true;
            resetProgress();
        }

        function resetProgress() {
            progressContainer.classList.add('hidden');
            downloadContainer.classList.add('hidden');
            statusMessage.className = 'status-message info';

            // Clear detailed status elements
            const stepIndicator = document.getElementById('stepIndicator');
            const progressPercent = document.getElementById('progressPercent');
            if (stepIndicator) stepIndicator.remove();
            if (progressPercent) progressPercent.remove();
        }

        async function convertFile() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);

            convertBtn.disabled = true;
            convertBtn.innerHTML = '<span class="loading-spinner"></span>å¤„ç†ä¸­...';
            progressContainer.classList.remove('hidden');

            // æ˜¾ç¤ºè¯¦ç»†çš„åˆå§‹çŠ¶æ€
            updateDetailedStatus({
                message: 'ğŸ“¤ æ­£åœ¨ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...',
                progress: 5,
                step: 'uploading',
                status: 'converting'
            });

            try {
                // æ˜¾ç¤ºä¸Šä¼ è¿›è¡Œä¸­çš„çŠ¶æ€
                updateDetailedStatus({
                    message: 'ğŸ“¡ æ­£åœ¨ä¼ è¾“æ–‡ä»¶æ•°æ®...',
                    progress: 8,
                    step: 'transferring',
                    status: 'converting'
                });

                const response = await fetch('/api/convert', {
                    method: 'POST',
                    body: formData
                });

                // ä¸Šä¼ å®Œæˆï¼Œç­‰å¾…æœåŠ¡å™¨å¤„ç†
                updateDetailedStatus({
                    message: 'â³ æœåŠ¡å™¨æ­£åœ¨å‡†å¤‡è½¬æ¢...',
                    progress: 10,
                    step: 'preparing',
                    status: 'converting'
                });

                const result = await response.json();

                if (response.ok) {
                    currentTaskId = result.task_id;
                    updateDetailedStatus({
                        message: 'âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œå¯åŠ¨è½¬æ¢å¼•æ“...',
                        progress: 15,
                        step: 'upload_complete',
                        status: 'converting'
                    });
                    pollConversionStatus();
                } else {
                    throw new Error(result.error || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                updateDetailedStatus({
                    message: `âŒ ä¸Šä¼ å¤±è´¥: ${error.message}`,
                    progress: 0,
                    step: 'error',
                    status: 'error'
                });
                convertBtn.disabled = false;
                convertBtn.innerHTML = 'âœ¨ å¼€å§‹è½¬æ¢';
            }
        }

        async function pollConversionStatus() {
            if (!currentTaskId) return;

            try {
                const response = await fetch(`/api/status/${currentTaskId}`);
                const status = await response.json();

                if (response.ok) {
                    if (status.status === 'converting') {
                        updateDetailedStatus(status);
                        setTimeout(pollConversionStatus, 1000);
                    } else if (status.status === 'completed') {
                        updateDetailedStatus(status);
                        statusMessage.className = 'status-message success';
                        convertBtn.innerHTML = 'âœ… è½¬æ¢å®Œæˆ';
                        downloadContainer.classList.remove('hidden');
                    } else if (status.status === 'error') {
                        updateDetailedStatus(status);
                        statusMessage.className = 'status-message error';
                        convertBtn.disabled = false;
                        convertBtn.innerHTML = 'âœ¨ é‡æ–°è½¬æ¢';
                    }
                }
            } catch (error) {
                updateStatus('è·å–çŠ¶æ€å¤±è´¥', 'error', 0);
                convertBtn.disabled = false;
                convertBtn.innerHTML = 'âœ¨ é‡æ–°è½¬æ¢';
            }
        }

        function updateStatus(message, type, progress) {
            statusText.textContent = message;
            statusMessage.className = `status-message ${type}`;
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
        }

        function updateDetailedStatus(data) {
            const { message, progress, step, status } = data;

            statusText.textContent = message;
            statusMessage.className = `status-message ${status === 'error' ? 'error' : 'info'}`;
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);

            // Update main progress percentage display
            const progressPercentage = document.getElementById('progressPercentage');
            if (progressPercentage) {
                progressPercentage.textContent = `${progress}%`;
            }

            // Add step indicator
            const stepIndicator = document.getElementById('stepIndicator');
            if (!stepIndicator) {
                const stepDiv = document.createElement('div');
                stepDiv.id = 'stepIndicator';
                stepDiv.style.fontSize = '0.9em';
                stepDiv.style.color = '#666';
                stepDiv.style.marginTop = '5px';
                statusMessage.appendChild(stepDiv);
            }

            const stepElement = document.getElementById('stepIndicator');
            if (stepElement && step) {
                // Show step description based on step name
                const stepDescriptions = {
                    'uploading': 'ğŸ“¤ æ­£åœ¨ä¸Šä¼ æ–‡ä»¶',
                    'transferring': 'ğŸ“¡ æ­£åœ¨ä¼ è¾“æ•°æ®',
                    'preparing': 'â³ æœåŠ¡å™¨å‡†å¤‡ä¸­',
                    'upload_complete': 'âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ',
                    'initialization': 'ğŸš€ å¼€å§‹åˆå§‹åŒ–',
                    'initializing': 'ğŸ”§ è®¾ç½®è½¬æ¢å™¨',
                    'opening_document': 'ğŸ“‚ æ‰“å¼€PDFæ–‡æ¡£',
                    'analyzing_document': 'ğŸ” åˆ†ææ–‡æ¡£ç»“æ„',
                    'extracting_content': 'ğŸ“ æå–å†…å®¹å…ƒç´ ',
                    'converting_elements': 'ğŸ”„ è½¬æ¢PDFå…ƒç´ ',
                    'preserving_formatting': 'ğŸ¨ ä¿ç•™æ ¼å¼å¸ƒå±€',
                    'generating_docx': 'ğŸ“„ ç”ŸæˆWordæ–‡æ¡£',
                    'finalizing': 'âœ¨ å®Œæˆå¤„ç†',
                    'completed': 'âœ… è½¬æ¢å®Œæˆ',
                    'error': 'âŒ å‘ç”Ÿé”™è¯¯'
                };

                stepElement.textContent = stepDescriptions[step] || `Step: ${step}`;
            }

            // Add progress percentage in status message (smaller one)
            const progressElement = document.getElementById('progressPercent');
            if (progressElement) {
                progressElement.textContent = `${progress}%`;
            } else {
                const progressDiv = document.createElement('div');
                progressDiv.id = 'progressPercent';
                progressDiv.style.fontSize = '0.8em';
                progressDiv.style.fontWeight = 'bold';
                progressDiv.style.marginTop = '5px';
                progressDiv.textContent = `${progress}%`;
                statusMessage.appendChild(progressDiv);
            }
        }

        async function cleanupFiles() {
            if (currentTaskId) {
                try {
                    await fetch(`/api/cleanup/${currentTaskId}`, {
                        method: 'DELETE'
                    });
                } catch (error) {
                    console.error('Cleanup failed:', error);
                }
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>